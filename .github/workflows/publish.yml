name: Publish to npm

# Triggers:
#   - Push a tag like v1.2.3 â†’ auto-publish to npm
#   - Manual dispatch with version bump type
on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  # â”€â”€ Run tests before publishing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Test before publish
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: interact
          POSTGRES_PASSWORD: interact
          POSTGRES_DB: interact_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm run typecheck

      - name: Run tests
        run: pnpm test
        env:
          DATABASE_URL: postgresql://interact:interact@localhost:5432/interact_test
          SECRET_KEY: test-secret-only-not-real-32chars

  # â”€â”€ Publish to npm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish-npm:
    name: Publish @ankr/interact to npm
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write   # for git tag + release
      id-token: write   # for npm provenance

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: pnpm/action-setup@v3
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Manual dispatch: bump version and create tag
      - name: Bump version (manual dispatch only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          npm version ${{ github.event.inputs.bump }} -m "chore(release): v%s"
          git push --follow-tags

      - name: Build package
        run: pnpm run build

      - name: Publish to npm (with provenance)
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Also publish to Verdaccio if self-hosted token is configured
      - name: Publish to Verdaccio (optional)
        if: vars.VERDACCIO_URL != ''
        run: |
          npm config set @ankr:registry ${{ vars.VERDACCIO_URL }}
          npm config set //${{ vars.VERDACCIO_URL }}/:_authToken ${{ secrets.VERDACCIO_TOKEN }}
          npm publish --registry ${{ vars.VERDACCIO_URL }}
        continue-on-error: true

  # â”€â”€ Create GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: publish-npm
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Extract changelog section
        id: changelog
        run: |
          # Pull latest commit messages since last tag as changelog
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s" $PREV_TAG..HEAD | grep -v "^- chore(release)" | head -30)
          else
            CHANGES="- Initial release"
          fi
          echo "CHANGES<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ANKR Interact v${{ steps.version.outputs.VERSION }}
          tag_name: ${{ github.ref_name }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.CHANGES }}

            ## Install

            ```bash
            npm install @ankr/interact@${{ steps.version.outputs.VERSION }}
            # or
            pnpm add @ankr/interact@${{ steps.version.outputs.VERSION }}
            ```

            ### Use the bundle library standalone

            ```typescript
            import { packBundle, validateBundle, diffBundles } from '@ankr/interact/bundles';
            ```

            ### Self-host with Docker

            ```bash
            docker compose up -d
            ```

            See [SELF_HOSTING.md](https://github.com/${{ github.repository }}/blob/main/SELF_HOSTING.md) for full setup guide.

            ---
            ðŸ”“ Apache 2.0 Â· [interact.ankrlabs.in](https://interact.ankrlabs.in)
          draft: false
          prerelease: false
          generate_release_notes: false
